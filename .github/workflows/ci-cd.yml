name: CI/CD Pipeline

on:
  push:
    branches: [main]
    paths: 
      - 'khimoo-portfolio/**'
      - 'articles/**'
      - 'flake.nix'
      - 'flake.lock'

env:
  CARGO_TERM_COLOR: always
  NIX_CONFIG: "experimental-features = nix-command flakes"
  RUST_BACKTRACE: 1
  CARGO_INCREMENTAL: 0
  # Nix environment variables
  NIXPKGS_ALLOW_UNFREE: 1
  FLAKE_LOCK_FALLBACK: 1

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write
      actions: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true
          
      - name: Verify LFS files
        run: |
          echo "ğŸ” Verifying LFS files are properly checked out..."
          echo "ğŸ“Š Image file info:"
          ls -la khimoo-portfolio/articles/img/ || echo "âŒ No image directory found"
          if [ -f "khimoo-portfolio/articles/img/author_img.png" ]; then
            file khimoo-portfolio/articles/img/author_img.png
            ls -lh khimoo-portfolio/articles/img/author_img.png
            echo "âœ… Image file exists and appears to be a real PNG file"
          else
            echo "âŒ author_img.png not found"
          fi
          
      - name: Optimize images for performance
        run: |
          echo "ğŸ–¼ï¸ Optimizing images for better performance..."
          # Install Pillow for image processing
          pip install Pillow
          
          # Run image optimization
          python3 optimize_images.py
          
          echo "ğŸ“Š Image optimization results:"
          ls -lh khimoo-portfolio/articles/img/author_img*.png khimoo-portfolio/articles/img/author_img*.webp 2>/dev/null || echo "No optimized images found"
          
          echo "âœ… Image optimization completed"
        
      - name: Setup Nix environment
        uses: cachix/install-nix-action@v26
        with:
          install_url: https://releases.nixos.org/nix/nix-2.21.2/install
          extra_nix_config: |
            experimental-features = nix-command flakes
            access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}
            substituters = https://cache.nixos.org/ https://devenv.cachix.org
            trusted-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= devenv.cachix.org-1:w1cLUi8dv3hnoSPGAuibQv+f9TZLr6cv/Hm9XgU50cw=
            warn-dirty = false
            
      - name: Setup Nix cache
        uses: cachix/cachix-action@v14
        with:
          name: devenv
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
          skipPush: true
          
      - name: Test Nix development environment
        run: |
          echo "ğŸ¦€ Testing Nix development environment..."
          nix develop --command echo "âœ… nix develop works!"
          
      - name: Process articles
        run: |
          echo "ğŸ“š Processing articles and generating metadata..."
          cd khimoo-portfolio
          mkdir -p data
          nix develop --command cargo run --features cli-tools --bin process-articles -- --articles-dir articles --output-dir data --verbose
          echo "âœ… Article processing completed"
          
      - name: Verify article processing results
        run: |
          echo "ğŸ” Verifying article processing results..."
          if [ -f "khimoo-portfolio/data/articles.json" ]; then
            echo "âœ… articles.json generated successfully"
            echo "ğŸ“Š Articles data file size:"
            ls -lh khimoo-portfolio/data/articles.json
            echo "ğŸ“„ Articles data preview (first 10 lines):"
            head -10 khimoo-portfolio/data/articles.json
            echo "ğŸ“ˆ Processing summary:"
            echo "   ğŸ“ Generated data files:"
            ls -la khimoo-portfolio/data/
          else
            echo "âŒ articles.json not found!"
            exit 1
          fi
          
      - name: Upload article processing artifacts
        uses: actions/upload-artifact@v4
        with:
          name: article-processing-results
          path: |
            khimoo-portfolio/data/articles.json
            khimoo-portfolio/data/link-graph.json
            khimoo-portfolio/data/validation-report.json
            khimoo-portfolio/data/validation-report.txt
            khimoo-portfolio/data/validation-summary.txt
          retention-days: 30
          
      - name: Generate link graph
        run: |
          echo "ğŸ•¸ï¸  Generating link graph from processed articles..."
          cd khimoo-portfolio
          nix develop --command cargo run --features cli-tools --bin generate-link-graph -- --articles-dir articles --output-dir data --verbose
          echo "âœ… Link graph generation completed"
          
      - name: Verify link graph generation
        run: |
          echo "ğŸ” Verifying link graph generation results..."
          if [ -f "khimoo-portfolio/data/link-graph.json" ]; then
            echo "âœ… link-graph.json generated successfully"
            echo "ğŸ“Š Link graph file size:"
            ls -lh khimoo-portfolio/data/link-graph.json
            echo "ğŸ“„ Link graph data preview (first 20 lines):"
            head -20 khimoo-portfolio/data/link-graph.json
            echo "ğŸ“ˆ Link graph summary:"
            echo "   ğŸ“ Updated data files:"
            ls -la khimoo-portfolio/data/
          else
            echo "âŒ link-graph.json not found!"
            exit 1
          fi
          
      - name: Build WebAssembly application
        run: |
          echo "ğŸš€ Building WebAssembly application with Trunk..."
          cd khimoo-portfolio
          
          # Debug: Check if image files exist before build
          echo "ğŸ” Checking image files before build:"
          ls -la articles/img/ || echo "âŒ No articles/img directory found"
          
          # Build with Trunk
          nix develop --command trunk build --release --public-url /khimoo.io/
          
          # Debug: Check dist directory after build
          echo "ğŸ” Checking dist directory after build:"
          ls -la dist/
          
          # Manually copy images to dist (including optimized versions)
          echo "ğŸ“¸ Manually copying image files to dist..."
          mkdir -p dist/articles/img
          if [ -d "articles/img" ]; then
            cp -v articles/img/* dist/articles/img/ 2>/dev/null || echo "âŒ Failed to copy images"
            echo "âœ… Images copied to dist/articles/img/"
            ls -la dist/articles/img/
          else
            echo "âŒ articles/img directory not found"
          fi
          
          echo "âœ… WebAssembly build completed"
          
      - name: Verify build artifacts
        run: |
          echo "ğŸ” Verifying build artifacts..."
          cd khimoo-portfolio
          ls -la dist/
          echo "ğŸ“Š Build artifact sizes:"
          du -h dist/
          
          # Check for images in dist
          echo "ğŸ” Checking for images in dist:"
          find dist -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" | head -10
          
          # Verify articles directory structure
          echo "ğŸ” Checking articles directory in dist:"
          ls -la dist/articles/ 2>/dev/null || echo "âŒ No articles directory in dist"
          ls -la dist/articles/img/ 2>/dev/null || echo "âŒ No articles/img directory in dist"
          
          echo "âœ… Build verification completed"
          
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: webassembly-build
          path: khimoo-portfolio/dist/
          retention-days: 30
          
      - name: Prepare deployment directory
        run: |
          echo "ğŸ“ Preparing deployment directory..."
          cp -r ./khimoo-portfolio/dist ./public
          cp ./public/index.html ./public/404.html
          cp ./test-data-loader.html ./public/test-data-loader.html
          
          # Ensure images are copied
          if [ -d "./khimoo-portfolio/articles/img" ]; then
            echo "ğŸ“¸ Copying image files..."
            mkdir -p ./public/articles/img
            cp -r ./khimoo-portfolio/articles/img/* ./public/articles/img/ 2>/dev/null || echo "No images to copy"
            echo "âœ… Image files copied"
            echo "ğŸ“Š Optimized images check:"
            ls -la ./public/articles/img/author_img*.png ./public/articles/img/author_img*.webp 2>/dev/null || echo "No optimized images found"
          fi
          
          echo "âœ… Deployment directory prepared"
          echo "ğŸ“Š Public directory contents:"
          ls -la ./public/
          echo "ğŸ“Š Data directory contents:"
          ls -la ./public/data/ || echo "âŒ Data directory not found in public!"
          echo "ğŸ“Š Articles directory contents:"
          ls -la ./public/articles/ || echo "âŒ Articles directory not found in public!"
          echo "ğŸ“Š Images directory contents:"
          ls -la ./public/articles/img/ || echo "âŒ Images directory not found in public!"
          echo "ğŸ“„ Checking articles.json in public:"
          if [ -f "./public/data/articles.json" ]; then
            echo "âœ… articles.json found in public directory"
            echo "ğŸ“Š File size:"
            ls -lh ./public/data/articles.json
            echo "ğŸ“„ Articles data preview (first 5 lines):"
            head -5 ./public/data/articles.json
            echo "ğŸ” Checking for home_display articles:"
            grep -c '"home_display": true' ./public/data/articles.json || echo "No home_display articles found"
          else
            echo "âŒ articles.json not found in public directory!"
          fi
          echo "ğŸ“„ Checking link-graph.json in public:"
          if [ -f "./public/data/link-graph.json" ]; then
            echo "âœ… link-graph.json found in public directory"
            echo "ğŸ“Š File size:"
            ls -lh ./public/data/link-graph.json
          else
            echo "âŒ link-graph.json not found in public directory!"
          fi
          
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          publish_branch: gh-pages
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: 'Deploy to GitHub Pages from ${{ github.sha }}'
          
      - name: Verify deployment
        run: |
          echo "âœ… GitHub Pages deployment completed"
          echo "ğŸŒ Site will be available at: https://${{ github.repository_owner }}.github.io/khimoo.io/"
          echo "ğŸ“ Deployment commit: ${{ github.sha }}"
          echo "ğŸ“ Deployed files:"
          ls -la ./public/
          echo "ğŸ“Š Total deployment size:"
          du -sh ./public/
          echo "ğŸ” Final verification - checking critical files:"
          echo "  - index.html: $([ -f ./public/index.html ] && echo 'âœ…' || echo 'âŒ')"
          echo "  - 404.html: $([ -f ./public/404.html ] && echo 'âœ…' || echo 'âŒ')"
          echo "  - data/articles.json: $([ -f ./public/data/articles.json ] && echo 'âœ…' || echo 'âŒ')"
          echo "  - data/link-graph.json: $([ -f ./public/data/link-graph.json ] && echo 'âœ…' || echo 'âŒ')"
          echo "ğŸ“ˆ Expected data loading URLs:"
          echo "  - Articles: https://${{ github.repository_owner }}.github.io/khimoo.io/data/articles.json"
          echo "  - Link Graph: https://${{ github.repository_owner }}.github.io/khimoo.io/data/link-graph.json"